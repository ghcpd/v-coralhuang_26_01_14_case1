User: # Task: Fix Mutable Default Parameter Anti-pattern in fake.py

## Problem

The `FakeUserAgent.__init__()` method uses mutable objects (e.g. lists) as default parameter values.
In Python, default arguments are evaluated once at function definition time, which can cause **state leakage between instances** when those defaults are mutated.

This leads to subtle, hard-to-detect bugs where modifying attributes on one instance affects subsequently created instances.

## Solution Requirements

### 1. Change function signature

* Replace all mutable default values (e.g. `["chrome", ...]`) with `None`
* Update type hints:

  * From `Union[list[str], str]`
  * To `Optional[Iterable[str]]`
* Add required imports:

  * `from collections.abc import Iterable`
  * `from typing import Optional`

### 2. Add helper functions (defined before the class)

Implement the following helpers and use them consistently in `__init__`:

* `_ensure_iterable(value, *, name: str) -> list[str]`

  * Accepts `None`, `str`, or `Iterable[str]`
  * Converts valid input into a new `list[str]`
  * Raises:

    * `TypeError` for non-iterable / invalid types
    * `ValueError` for empty or invalid contents when applicable

* `_ensure_float(value, *, name: str) -> float`

  * Accepts `int` or `float`
  * Converts to `float`
  * Raises `TypeError` for invalid input

### 3. Refactor `__init__` validation logic

* Remove all `assert` statements
* Replace them with explicit validation via the helper functions
* Raise `TypeError` / `ValueError` instead of `AssertionError`
* Preserve existing behavior and logic:

  * OS replacement logic (`OS_REPLACEMENTS`)
  * Browser normalization
  * Fallback behavior
  * Public API compatibility

### 4. Testing requirements (mandatory)

The agent **must extend or add tests** to explicitly validate the fix.

At minimum, tests must cover:

#### a) No shared mutable defaults

* Create two separate `FakeUserAgent` instances
* Mutate a list attribute (e.g. `browsers`, `platforms`, or `os`) on the first instance
* Assert that the second instance is **not affected**

Example expectation (conceptual):

```python
ua1 = FakeUserAgent()
ua1.browsers.append("opera")

ua2 = FakeUserAgent()
assert "opera" not in ua2.browsers
```

#### b) Iterable flexibility

* Verify that passing different iterable types works:

  * `list`
  * `tuple`
  * `set`
* Verify that invalid types raise the correct exception

#### c) Error type correctness

* Ensure invalid inputs raise `TypeError` or `ValueError`
* No `AssertionError` should be raised from `__init__`

### 5. Test execution

* Tests must run via `pytest` or `unittest` without manual intervention
* The test suite must clearly fail if mutable default behavior is reintroduced

## Deliverables

1. **Modified `fake.py`**

   * Mutable defaults removed
   * Helper functions added
   * Validation refactored

2. **Updated or extended `test_fake.py`**

   * Includes explicit regression tests for mutable defaults
   * Covers iterable handling and error behavior

3. **README.md**

   * Brief explanation of:

     * The mutable default parameter issue
     * Why it is dangerous
     * How the fix prevents cross-instance state leakage

4. **run_tests.bat / run_tests.sh**

   * One-click test runner
   * Clearly reports success or failure

GitHub Copilot: Created 5 todos

Read [](file:///c%3A/Bug_Bash/26_01_15/oswe-large-m5a1s120/fake.py)

Read [](file:///c%3A/Bug_Bash/26_01_15/oswe-large-m5a1s120/utils.py)

Read [](file:///c%3A/Bug_Bash/26_01_15/oswe-large-m5a1s120/test_fake.py)

Using "Replace String in File"


```

```


Using "Replace String in File"


```

```


Using "Replace String in File"

Searched for text `class FakeUserAgent` (`**/fake.py`), 1 result

Read [](file:///c%3A/Bug_Bash/26_01_15/oswe-large-m5a1s120/fake.py#80-80), lines 80 to 300

Using "Replace String in File"

Using "Replace String in File"


```

```


Using "Replace String in File"


```

```


Using "Replace String in File"


```

```


Using "Replace String in File"

Read [](file:///c%3A/Bug_Bash/26_01_15/oswe-large-m5a1s120/fake.py#90-90), lines 90 to 170

Using "Replace String in File"


```

```


Using "Replace String in File"


```

```


Using "Replace String in File"


```

```


Using "Replace String in File"


```

```


Using "Replace String in File"


```

```


Using "Replace String in File"


```

```


Using "Replace String in File"


```

```


Using "Replace String in File"


```

```


Read [](file:///c%3A/Bug_Bash/26_01_15/oswe-large-m5a1s120/fake.py#60-60), lines 60 to 200

Read [](file:///c%3A/Bug_Bash/26_01_15/oswe-large-m5a1s120/fake.py#1-1), lines 1 to 81

Continue to iterate?
[object Object]

Made changes.

User: @agent Continue: "Continue to iterate?"

GitHub Copilot: Optimizing tool selection...

Starting: *Refactor FakeUserAgent defaults & validation* (2/5)

Using "Replace String in File"


```

```


Using "Replace String in File"


```

```


Using "Replace String in File"


```

```


Read [](file:///c%3A/Bug_Bash/26_01_15/oswe-large-m5a1s120/fake.py#1-1), lines 1 to 81

Using "Replace String in File"


```

```


Using "Replace String in File"


```

```


Using "Replace String in File"


```

```


Using "Replace String in File"


```

```


Using "Replace String in File"


```

```


Using "Replace String in File"


```

```


Using "Replace String in File"


```

```


Using "Edit File"

Using ""


````

````


Read [](file:///c%3A/Bug_Bash/26_01_15/oswe-large-m5a1s120/test_fake.py)

Configuring a Python Environment
Completed with input: {
  "resourcePath": "c:\\Bug_Bash\\26_01_15\\oswe-large-m5a1s120"
}

Ran `pylancePythonEnvironments` 
Completed with input: {
  "workspaceRoot": "c:\\Bug_Bash\\26_01_15\\oswe-large-m5a1s120"
}

Discovering tests...

Ran terminal command: python -m pytest -q

Completed: *Refactor FakeUserAgent defaults & validation* (2/5)

Created [](file:///c%3A/Bug_Bash/26_01_15/oswe-large-m5a1s120/README.md)

Created [](file:///c%3A/Bug_Bash/26_01_15/oswe-large-m5a1s120/run_tests.sh)

Created [](file:///c%3A/Bug_Bash/26_01_15/oswe-large-m5a1s120/run_tests.bat)

Completed: *Add README note about mutable defaults* (4/5)

Read [](file:///c%3A/Bug_Bash/26_01_15/oswe-large-m5a1s120/fake.py#1-1), lines 1 to 41

Updated todo list

Read [](file:///c%3A/Bug_Bash/26_01_15/oswe-large-m5a1s120/run_tests.bat)

Read [](file:///c%3A/Bug_Bash/26_01_15/oswe-large-m5a1s120/run_tests.sh)

Read [](file:///c%3A/Bug_Bash/26_01_15/oswe-large-m5a1s120/README.md)

Read [](file:///c%3A/Bug_Bash/26_01_15/oswe-large-m5a1s120/test_fake.py#120-120), lines 120 to 222

Updated todo list

Ran `pylanceRunCodeSnippet` 
Completed with input: {
  "workspaceRoot": "c:\\Bug_Bash\\26_01_15\\oswe-large-m5a1s120",
  "codeSnippet": "import fake\nprint(fake.DEFAULT_BROWSERS)\nprint(fake._ensure_iterable(['a','b'], name='x'))"
}

Ran terminal command: python -m pytest -q

Updated todo list

Read [](file:///c%3A/Bug_Bash/26_01_15/oswe-large-m5a1s120/fake.py#200-200), lines 200 to 280

Updated todo list

Updated todo list

Updated todo list

Updated todo list

Updated todo list

Continue to iterate?
[object Object]

Made changes.

User: @agent Continue: "Continue to iterate?"

GitHub Copilot: Ran terminal command: echo preamble-marker

Created 5 todos

Ran terminal command: REM preamble message handled separately

Updated todo list

## âœ… Summary
- Removed mutable defaults from `FakeUserAgent.__init__` by switching to `None` sentinels and validating via fresh-list helpers.
- Added `_ensure_iterable` and `_ensure_float` helpers to enforce types, prevent state leakage, and replace `assert`-based checks with explicit `TypeError`/`ValueError`.
- Extended tests to guard against shared defaults, validate iterable flexibility, and ensure correct exception types. All **31 tests pass** (warnings only from expected fallback paths).
- Added README.md plus run_tests.sh / run_tests.bat for one-click test runs.

---

## ğŸ”§ Key Code Changes (fake.py)
```python
from collections.abc import Iterable, Mapping
from typing import Any, Optional, Union
# ...

DEFAULT_BROWSERS = ("chrome", "edge", "firefox", "safari")
DEFAULT_OS = ("windows", "macos", "linux", "android", "ios")
DEFAULT_PLATFORMS = ("pc", "mobile", "tablet")


def _ensure_iterable(value: Optional[Iterable[str]], *, name: str, allow_empty: bool = False) -> list[str]:
    if value is None:
        items: list[Any] = []
    elif isinstance(value, str_types):
        items = [value]
    elif isinstance(value, Mapping):
        raise TypeError(f"{name} must be an iterable of strings")
    elif isinstance(value, Iterable):
        items = list(value)
    else:
        raise TypeError(f"{name} must be an iterable of strings")

    if not items and not allow_empty:
        raise ValueError(f"{name} cannot be empty")
    if not all(isinstance(item, str_types) for item in items):
        raise ValueError(f"{name} must contain only strings")
    return list(items)


def _ensure_float(value: Any, *, name: str) -> float:
    if isinstance(value, (float, int)):
        return float(value)
    raise TypeError(f"{name} must be float or int")


class FakeUserAgent:
    def __init__(  # noqa: PLR0913
        self,
        browsers: Optional[Iterable[str]] = None,
        os: Optional[Iterable[str]] = None,
        min_version: float = 0.0,
        min_percentage: float = 0.0,
        platforms: Optional[Iterable[str]] = None,
        fallback: str = (
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) "
            "AppleWebKit/537.36 (KHTML, like Gecko) "
            "Chrome/122.0.0.0 Safari/537.36 Edg/122.0.0.0"
        ),
        safe_attrs: Optional[Iterable[str]] = None,
    ):
        self.browsers = _ensure_iterable(DEFAULT_BROWSERS if browsers is None else browsers, name="browsers")
        raw_os = _ensure_iterable(DEFAULT_OS if os is None else os, name="os")
        self.os: list[str] = []
        for os_name in raw_os:
            if os_name in settings.OS_REPLACEMENTS:
                self.os.extend(settings.OS_REPLACEMENTS[os_name])
            else:
                self.os.append(os_name)

        self.min_percentage = _ensure_float(min_percentage, name="min_percentage")
        self.min_version = _ensure_float(min_version, name="min_version")
        self.platforms = _ensure_iterable(DEFAULT_PLATFORMS if platforms is None else platforms, name="platforms")

        if not isinstance(fallback, str_types):
            raise TypeError("fallback must be string")
        self.fallback = fallback

        safe_attrs_list = _ensure_iterable(safe_attrs, name="safe_attrs", allow_empty=True) if safe_attrs is not None else []
        self.safe_attrs: set[str] = set(safe_attrs_list)
```

> ğŸ’¡ OS replacements, browser normalization, fallback behavior, and the `UserAgent` alias remain unchanged.

---

## ğŸ§ª Tests (updated test_fake.py)
- âœ… **No shared mutable defaults** across instances (`browsers`, `os`, `platforms`).
- âœ… **Iterable flexibility**: accepts `list`, `tuple`, `set`; rejects mappings/invalid elements.
- âœ… **Error types**: `TypeError`/`ValueError` only; no `AssertionError` from `__init__`.
- âœ… OS replacement regression (`"windows"` â†’ `["win10", "win7"]`).
- âœ… Numeric inputs (`int`) normalized to `float`.

> ğŸŸ¢ `python -m pytest -q` â†’ **31 passed**, 5 expected warnings from fallback handling.

---

## ğŸ“„ Files Touched

| File            | Description |
|-----------------|-------------|
| fake.py       | Added helpers, removed mutable defaults & asserts, explicit validation |
| test_fake.py  | Added regression tests for shared defaults, iterables, error types |
| README.md     | Explained mutable default pitfalls and the fix |
| run_tests.sh  | POSIX test runner (`python -m pytest -q`) |
| run_tests.bat | Windows test runner (`python -m pytest -q`) |

---

## â–¶ï¸ Run Tests

```bash
# POSIX
./run_tests.sh
```

```bat
REM Windows
run_tests.bat
```

Both scripts pass through any extra args to `pytest` and exit with the test status.

---

## âœ… Quick Checks
- Defaults now use `None` sentinels and `_ensure_iterable` returns a **fresh list** each time.
- Invalid types (e.g., `browsers=52`, `safe_attrs={}`) raise `TypeError`; invalid contents (e.g., `safe_attrs=[66]`) raise `ValueError`.
- Public API (`UserAgent`, attribute accessors, `getBrowser`) unchanged; `OS_REPLACEMENTS` still applied.

If you want me to silence the fallback warnings in tests (e.g., via `pytest.warns` or `filterwarnings`), I can add that too.