User: # Task: Fix Mutable Default Parameter Anti-pattern in fake.py

## Problem

The `FakeUserAgent.__init__()` method uses mutable objects (e.g. lists) as default parameter values.
In Python, default arguments are evaluated once at function definition time, which can cause **state leakage between instances** when those defaults are mutated.

This leads to subtle, hard-to-detect bugs where modifying attributes on one instance affects subsequently created instances.

## Solution Requirements

### 1. Change function signature

* Replace all mutable default values (e.g. `["chrome", ...]`) with `None`
* Update type hints:

  * From `Union[list[str], str]`
  * To `Optional[Iterable[str]]`
* Add required imports:

  * `from collections.abc import Iterable`
  * `from typing import Optional`

### 2. Add helper functions (defined before the class)

Implement the following helpers and use them consistently in `__init__`:

* `_ensure_iterable(value, *, name: str) -> list[str]`

  * Accepts `None`, `str`, or `Iterable[str]`
  * Converts valid input into a new `list[str]`
  * Raises:

    * `TypeError` for non-iterable / invalid types
    * `ValueError` for empty or invalid contents when applicable

* `_ensure_float(value, *, name: str) -> float`

  * Accepts `int` or `float`
  * Converts to `float`
  * Raises `TypeError` for invalid input

### 3. Refactor `__init__` validation logic

* Remove all `assert` statements
* Replace them with explicit validation via the helper functions
* Raise `TypeError` / `ValueError` instead of `AssertionError`
* Preserve existing behavior and logic:

  * OS replacement logic (`OS_REPLACEMENTS`)
  * Browser normalization
  * Fallback behavior
  * Public API compatibility

### 4. Testing requirements (mandatory)

The agent **must extend or add tests** to explicitly validate the fix.

At minimum, tests must cover:

#### a) No shared mutable defaults

* Create two separate `FakeUserAgent` instances
* Mutate a list attribute (e.g. `browsers`, `platforms`, or `os`) on the first instance
* Assert that the second instance is **not affected**

Example expectation (conceptual):

```python
ua1 = FakeUserAgent()
ua1.browsers.append("opera")

ua2 = FakeUserAgent()
assert "opera" not in ua2.browsers
```

#### b) Iterable flexibility

* Verify that passing different iterable types works:

  * `list`
  * `tuple`
  * `set`
* Verify that invalid types raise the correct exception

#### c) Error type correctness

* Ensure invalid inputs raise `TypeError` or `ValueError`
* No `AssertionError` should be raised from `__init__`

### 5. Test execution

* Tests must run via `pytest` or `unittest` without manual intervention
* The test suite must clearly fail if mutable default behavior is reintroduced

## Deliverables

1. **Modified `fake.py`**

   * Mutable defaults removed
   * Helper functions added
   * Validation refactored

2. **Updated or extended `test_fake.py`**

   * Includes explicit regression tests for mutable defaults
   * Covers iterable handling and error behavior

3. **README.md**

   * Brief explanation of:

     * The mutable default parameter issue
     * Why it is dangerous
     * How the fix prevents cross-instance state leakage

4. **run_tests.bat / run_tests.sh**

   * One-click test runner
   * Clearly reports success or failure

GitHub Copilot: Read [](file:///c%3A/Bug_Bash/26_01_15/gpt-5.1-codex-max)

Read [](file:///c%3A/Bug_Bash/26_01_15/gpt-5.1-codex-max/fake.py)

Read [](file:///c%3A/Bug_Bash/26_01_15/gpt-5.1-codex-max/test_fake.py)

Read [](file:///c%3A/Bug_Bash/26_01_15/gpt-5.1-codex-max/utils.py)

Using "Apply Patch"


```

```


Using "Apply Patch"


```

```


Using "Apply Patch"


```

```


Created [](file:///c%3A/Bug_Bash/26_01_15/gpt-5.1-codex-max/README.md)

Created [](file:///c%3A/Bug_Bash/26_01_15/gpt-5.1-codex-max/run_tests.bat)

Created [](file:///c%3A/Bug_Bash/26_01_15/gpt-5.1-codex-max/run_tests.sh)

Read [](file:///c%3A/Bug_Bash/26_01_15/gpt-5.1-codex-max/fake.py#1-1), lines 1 to 220

Using "Apply Patch"


```

```
**Changes**
- Added `_DEFAULT_*` immutable defaults plus `_ensure_iterable` and `_ensure_float` validators to rebuild fresh lists and raise clear errors instead of assertions in fake.py.
- Refactored `FakeUserAgent.__init__` to use the new helpers, remove mutable defaults, and keep OS replacement and fallback behavior intact while enforcing TypeError/ValueError signaling in fake.py.
- Expanded coverage to catch shared-default regressions, iterable flexibility, and strict error typing; updated prior expectations from AssertionError to TypeError/ValueError in test_fake.py.
- Documented the mutable-default risk and added one-click test runners in README.md, run_tests.bat, and run_tests.sh.

**Tests**
- Not run (let me know if you want me to execute run_tests.bat / run_tests.sh).

Made changes.